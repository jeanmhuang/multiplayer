<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Champions - Real Multiplayer</title>

    <!-- Social preview for LinkedIn/Twitter (thumbnail) -->
    <meta property="og:title" content="Climate Champions - Real Multiplayer">
    <meta property="og:description" content="Real-time cooperative climate action game. Team up to plant trees, clean pollution, and deploy solar to reach 100% ecosystem health.">
    <meta property="og:image" content="https://github.com/jeanmhuang/multiplayer/raw/main/thumbnail.png">
    <meta property="og:url" content="https://jeanmhuang.github.io/multiplayer/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://github.com/jeanmhuang/multiplayer/raw/main/thumbnail.png">

    <!-- Favicon (emoji sprout) -->
    <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><text y="14" font-size="14">üå±</text></svg>'>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            background: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #gameCanvas {
            display: block;
        }
        
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
            overflow-y: auto;
            padding: 30px 20px;
        }
        
        #startScreen h1 {
            font-size: 64px;
            margin-bottom: 10px;
            margin-top: 20px;
            color: #4ade80;
            text-shadow: 0 0 30px rgba(74, 222, 128, 0.5);
            letter-spacing: 2px;
        }
        
        @media (max-width: 768px) {
            #startScreen h1 {
                font-size: 48px;
            }
        }
        
        @media (max-width: 480px) {
            #startScreen h1 {
                font-size: 36px;
            }
        }
        
        .subtitle {
            font-size: 20px;
            color: #93c5fd;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .multiplayer-badge {
            background: rgba(74, 222, 128, 0.2);
            padding: 10px 20px;
            border-radius: 20px;
            border: 2px solid #4ade80;
            margin-bottom: 30px;
            font-size: 16px;
            font-weight: bold;
            color: #4ade80;
        }
        
        .mission {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 15px;
            max-width: 600px;
            margin-bottom: 30px;
            border: 2px solid rgba(74, 222, 128, 0.3);
        }
        
        .mission h3 {
            color: #4ade80;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .mission ul {
            list-style: none;
            padding: 0;
        }
        
        .mission li {
            padding: 8px 0;
            padding-left: 30px;
            position: relative;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .mission li:before {
            content: "üåç";
            position: absolute;
            left: 0;
        }
        
        #nameInput {
            padding: 15px 25px;
            font-size: 18px;
            border: 3px solid #4ade80;
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a1a;
            border-radius: 10px;
            margin-bottom: 20px;
            width: 350px;
            text-align: center;
            font-weight: 600;
        }
        
        #nameInput:focus {
            outline: none;
            box-shadow: 0 0 30px rgba(74, 222, 128, 0.6);
        }
        
        #startButton {
            padding: 18px 60px;
            font-size: 26px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(74, 222, 128, 0.4);
        }
        
        #startButton:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(74, 222, 128, 0.6);
        }
        
        #startButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-message {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            padding: 15px 30px;
            background: rgba(251, 191, 36, 0.95);
            border: 2px solid #fbbf24;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.95);
            border-color: #ef4444;
            color: white;
        }
        
        .success-message {
            background: rgba(74, 222, 128, 0.95);
            border-color: #4ade80;
            color: black;
        }
        
        .controls {
            margin-top: 20px;
            color: #cbd5e1;
            font-size: 14px;
            text-align: center;
        }
        
        .controls div {
            margin: 6px 0;
        }
        
        .toggle-setup {
            margin-top: 15px;
            padding: 12px 24px;
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid #3b82f6;
            color: #3b82f6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .toggle-setup:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 12px;
            font-size: 16px;
            border: 2px solid #4ade80;
            backdrop-filter: blur(10px);
            z-index: 100;
            min-width: 250px;
        }
        
        #hud h3 {
            margin-bottom: 15px;
            color: #4ade80;
            font-size: 20px;
            text-align: center;
            border-bottom: 2px solid #4ade80;
            padding-bottom: 10px;
        }
        
        .stat {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }
        
        .stat-label {
            font-weight: 600;
            color: #93c5fd;
        }
        
        .stat-value {
            font-weight: bold;
            color: #4ade80;
            font-size: 18px;
        }
        
        #health {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #4ade80;
            backdrop-filter: blur(10px);
            z-index: 100;
            min-width: 280px;
        }
        
        #health h3 {
            color: #4ade80;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
        }
        
        .health-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 2px solid #4ade80;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #4ade80);
            transition: width 0.5s;
            border-radius: 13px;
        }
        
        .health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }
        
        #actionButtons {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
        }
        
        .action-btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: 3px solid;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .action-btn.active {
            transform: scale(1.1);
            box-shadow: 0 0 30px currentColor;
        }
        
        #treeBtn {
            background: rgba(34, 197, 94, 0.3);
            color: #22c55e;
            border-color: #22c55e;
        }
        
        #cleanupBtn {
            background: rgba(59, 130, 246, 0.3);
            color: #3b82f6;
            border-color: #3b82f6;
        }
        
        #solarBtn {
            background: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
            border-color: #fbbf24;
        }
        
        #instructionsBtn {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            background: rgba(147, 51, 234, 0.3);
            color: #a855f7;
            border: 2px solid #a855f7;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        
        #instructionsBtn:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 20px rgba(168, 85, 247, 0.4);
        }
        
        #instructionsModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .instructions-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid #4ade80;
            box-shadow: 0 0 50px rgba(74, 222, 128, 0.5);
        }
        
        .instructions-content h2 {
            color: #4ade80;
            margin-bottom: 25px;
            font-size: 32px;
            text-align: center;
        }
        
        .instructions-content h3 {
            color: #93c5fd;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .instructions-content p, .instructions-content li {
            color: white;
            line-height: 1.8;
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        .instructions-content ul {
            list-style: none;
            padding-left: 0;
        }
        
        .instructions-content li {
            padding-left: 30px;
            position: relative;
            margin-bottom: 10px;
        }
        
        .instructions-content li:before {
            content: "‚Üí";
            position: absolute;
            left: 10px;
            color: #4ade80;
            font-weight: bold;
        }
        
        .close-btn {
            display: block;
            margin: 30px auto 0;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(74, 222, 128, 0.6);
        }
        
        #leaderboard {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #fbbf24;
            backdrop-filter: blur(10px);
            z-index: 100;
            min-width: 250px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        #leaderboard h3 {
            color: #fbbf24;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
            border-bottom: 2px solid #fbbf24;
            padding-bottom: 10px;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            color: white;
        }
        
        .player-name {
            font-weight: 600;
            color: #93c5fd;
        }
        
        .player-score {
            font-weight: bold;
            color: #4ade80;
        }
        
        .player-item.me {
            background: rgba(74, 222, 128, 0.2);
            border: 1px solid #4ade80;
        }
        
        /* Scrollbar styling */
        #leaderboard::-webkit-scrollbar {
            width: 8px;
        }
        
        #leaderboard::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        #leaderboard::-webkit-scrollbar-thumb {
            background: #fbbf24;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="startScreen">
        <h1>üåç Climate Champions</h1>
        <div class="subtitle">Real-Time Multiplayer Climate Action</div>
        <div class="multiplayer-badge">üåê LIVE MULTIPLAYER ‚Ä¢ WORK TOGETHER</div>
        
        <div class="mission">
            <h3>üéØ Your Mission</h3>
            <ul>
                <li>Team up with players worldwide in real-time</li>
                <li>Plant trees to restore forests</li>
                <li>Clean up pollution across the planet</li>
                <li>Deploy solar panels for clean energy</li>
                <li>Reach 100% Global Ecosystem Health together!</li>
            </ul>
        </div>
        
        <input type="text" id="nameInput" placeholder="Enter your hero name..." maxlength="20">
        <button id="startButton">Join the Mission</button>
        
        <div class="controls">
            <div><strong>Movement:</strong> WASD or Arrow Keys</div>
            <div><strong>Actions:</strong> 1, 2, 3 or T, C, S keys</div>
            <div><strong>Or click the action buttons!</strong></div>
        </div>
    </div>
    
    <canvas id="gameCanvas"></canvas>
    
    <div id="hud" style="display: none;">
        <h3>üìä Your Impact</h3>
        <div class="stat">
            <span class="stat-label">üå≥ Trees:</span>
            <span class="stat-value" id="trees">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">üßπ Cleaned:</span>
            <span class="stat-value" id="cleaned">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">‚òÄÔ∏è Solar:</span>
            <span class="stat-value" id="solar">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">‚≠ê Total Impact:</span>
            <span class="stat-value" id="impact">0</span>
        </div>
    </div>
    
    <div id="health" style="display: none;">
        <h3>üåç Global Ecosystem Health</h3>
        <div class="health-bar">
            <div class="health-fill" id="healthFill" style="width: 0%"></div>
            <div class="health-text" id="healthText">0%</div>
        </div>
    </div>
    
    <button id="instructionsBtn" style="display: none;">üìñ How to Play</button>
    
    <div id="instructionsModal">
        <div class="instructions-content">
            <h2>üéÆ How to Play Climate Champions</h2>
            
            <h3>üéØ Goal</h3>
            <p>Work together with all players to reach <strong>100% Global Ecosystem Health!</strong></p>
            
            <h3>üïπÔ∏è Controls</h3>
            <ul>
                <li><strong>WASD</strong> or <strong>Arrow Keys</strong> - Move your character</li>
                <li><strong>T or 1</strong> - Plant Tree mode</li>
                <li><strong>C or 2</strong> - Cleanup mode</li>
                <li><strong>S or 3</strong> - Solar Panel mode</li>
                <li><strong>Spacebar</strong> - Perform selected action</li>
                <li><strong>Escape</strong> - Close this menu</li>
            </ul>
            
            <h3>üå± Actions</h3>
            <ul>
                <li><strong>üå≥ Plant Trees:</strong> Adds +5 health, +5 impact</li>
                <li><strong>üßπ Clean Pollution:</strong> Removes pollution, +3 health, +3 impact</li>
                <li><strong>‚òÄÔ∏è Deploy Solar:</strong> Clean energy, +0.4 health, +8 impact</li>
            </ul>
            
            <h3>üí° Tips</h3>
            <ul>
                <li>All players share the same world in real-time!</li>
                <li>Focus on cleaning pollution first - it hurts ecosystem health</li>
                <li>Solar panels can't be placed on water or where trees exist</li>
                <li>Watch the leaderboard to see top contributors</li>
                <li>Pollution now spawns continuously - keep the world clean!</li>
            </ul>
            
            <button class="close-btn" onclick="hideInstructions()">Got It!</button>
        </div>
    </div>
    
    <div id="actionButtons" style="display: none;">
        <button class="action-btn" id="treeBtn">üå≥ Tree (T/1)</button>
        <button class="action-btn" id="cleanupBtn">üßπ Clean (C/2)</button>
        <button class="action-btn" id="solarBtn">‚òÄÔ∏è Solar (S/3)</button>
    </div>
    
    <div id="leaderboard" style="display: none;">
        <h3>üèÜ Top Contributors</h3>
        <div id="playersList"></div>
    </div>
    
    <div id="statusMessage" class="status-message" style="display: none;"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase config (using existing config from the page)
        const firebaseConfig = {
            apiKey: "AIzaSyD_x-rWGzmUvpZz6fLNYfpHdM5sVhP0Oe8",
            authDomain: "multiplayergame-76cdd.firebaseapp.com",
            databaseURL: "https://multiplayergame-76cdd-default-rtdb.firebaseio.com",
            projectId: "multiplayergame-76cdd",
            storageBucket: "multiplayergame-76cdd.firebasestorage.app",
            messagingSenderId: "1058026621878",
            appId: "1:1058026621878:web:c77e4d866f05e9fbc7b6f3"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const gameRef = database.ref('game');
        
        console.log('‚úÖ Firebase initialized successfully!');
        console.log('üåç Climate Champions ready to start!');
        
        function setupGame() {
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        // Game constants
        const TILE_SIZE = 64;
        const WORLD_SIZE = 3200;
        const PLAYER_SIZE = 16;
        const GRID_SIZE = WORLD_SIZE / TILE_SIZE;
        
        // Game state
        let gameStarted = false;
        let playerId = null;
        let player = null;
        let connectedPlayers = {};
        let currentAction = 'tree';
        let keys = {};
        
        // World data
        let tiles = [];
        let trees = [];
        let pollution = [];
        let solarPanels = [];
        let ecosystemHealth = 0;
        
        // Camera
        let camera = { x: 0, y: 0 };
        
        // Pollution spawning settings
        const POLLUTION_SPAWN_INTERVAL = 8000; // 8 seconds
        const MAX_POLLUTION = 80; // Maximum pollution on map
        const MIN_POLLUTION = 20; // Minimum pollution to maintain
        let pollutionSpawnTimer = null;
        
        // Tile colors
        const TILE_COLORS = {
            grass: '#7cb342',
            dirt: '#8d6e63',
            water: '#42a5f5',
            polluted_land: '#5d4037',
            polluted_water: '#263238'
        };
        
        // Player class
        class Player {
            constructor(data) {
                this.id = data.id;
                this.name = data.name;
                this.x = data.x;
                this.y = data.y;
                this.color = data.color;
                this.treesPlanted = data.treesPlanted || 0;
                this.pollutionCleaned = data.pollutionCleaned || 0;
                this.solarDeployed = data.solarDeployed || 0;
                this.impact = data.impact || 0;
            }
            
            draw() {
                // Draw player circle
                ctx.beginPath();
                ctx.arc(this.x - camera.x, this.y - camera.y, PLAYER_SIZE, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Draw name tag
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.name, this.x - camera.x, this.y - camera.y - 25);
            }
        }
        
        // Initialize world
        function initWorld() {
            tiles = [];
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    const rand = Math.random();
                    let type = 'grass';
                    if (rand < 0.15) type = 'water';
                    else if (rand < 0.18) type = 'dirt';
                    
                    tiles.push({ x, y, type });
                }
            }
        }
        
        function getTile(x, y) {
            if (x < 0 || x >= GRID_SIZE || y < 0 || y >= GRID_SIZE) return null;
            return tiles[y * GRID_SIZE + x];
        }
        
        // Generate random color
        function randomColor() {
            const colors = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef', '#ec4899'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // Show status message
        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + type + '-message';
            statusEl.style.display = 'block';
        }
        
        // Instructions modal
        function showInstructions() {
            document.getElementById('instructionsModal').style.display = 'flex';
        }
        
        function hideInstructions() {
            document.getElementById('instructionsModal').style.display = 'none';
        }
        
        // Update players list
        function updatePlayersList() {
            const allPlayers = [player, ...Object.values(connectedPlayers)].filter(p => p);
            allPlayers.sort((a, b) => b.impact - a.impact);
            
            const listHtml = allPlayers.slice(0, 10).map((p, index) => {
                const isMe = p.id === playerId;
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                return `
                    <div class="player-item ${isMe ? 'me' : ''}">
                        <span class="player-name">${medal} ${p.name}</span>
                        <span class="player-score">${p.impact}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('playersList').innerHTML = listHtml;
        }
        
        // Start pollution spawning
        function startPollutionSpawning() {
            console.log('üè≠ Starting continuous pollution spawning...');
            
            pollutionSpawnTimer = setInterval(async () => {
                if (!gameStarted || pollution.length >= MAX_POLLUTION) return;
                
                // Spawn 2-4 pollution pieces at a time
                const spawnCount = Math.floor(Math.random() * 3) + 2;
                
                for (let i = 0; i < spawnCount && pollution.length < MAX_POLLUTION; i++) {
                    // Find a valid spawn location
                    let attempts = 0;
                    let validLocation = false;
                    let gridX, gridY;
                    
                    while (!validLocation && attempts < 50) {
                        gridX = Math.floor(Math.random() * GRID_SIZE);
                        gridY = Math.floor(Math.random() * GRID_SIZE);
                        
                        const tile = getTile(gridX, gridY);
                        if (tile && tile.type !== 'water' && tile.type !== 'polluted_water') {
                            // Check if pollution already exists here
                            const pollutionExists = pollution.some(p => 
                                Math.floor(p.x / TILE_SIZE) === gridX && 
                                Math.floor(p.y / TILE_SIZE) === gridY
                            );
                            
                            if (!pollutionExists) {
                                validLocation = true;
                            }
                        }
                        attempts++;
                    }
                    
                    if (validLocation) {
                        const pollutionId = `pollution_${gridX}_${gridY}_${Date.now()}_${Math.random()}`;
                        const x = gridX * TILE_SIZE + TILE_SIZE / 2;
                        const y = gridY * TILE_SIZE + TILE_SIZE / 2;
                        
                        try {
                            await gameRef.child('world/pollution').child(pollutionId).set({
                                x: x,
                                y: y,
                                gridX: gridX,
                                gridY: gridY
                            });
                            
                            // Decrease ecosystem health slightly
                            const newHealth = Math.max(0, ecosystemHealth - 0.3);
                            await gameRef.child('world/health').set(newHealth);
                            
                            console.log('üè≠ New pollution spawned at:', gridX, gridY);
                        } catch (error) {
                            console.error('Error spawning pollution:', error);
                        }
                    }
                }
                
                // Show notification every few spawns
                if (Math.random() < 0.3) {
                    showStatus('üè≠ More pollution detected!', 'error');
                    setTimeout(() => {
                        document.getElementById('statusMessage').style.display = 'none';
                    }, 2000);
                }
            }, POLLUTION_SPAWN_INTERVAL);
        }
        
        // Stop pollution spawning
        function stopPollutionSpawning() {
            if (pollutionSpawnTimer) {
                clearInterval(pollutionSpawnTimer);
                pollutionSpawnTimer = null;
                console.log('üõë Stopped pollution spawning');
            }
        }
        
        // Initialize game
        async function init() {
            console.log('üöÄ Starting game initialization...');
            
            const nameInput = document.getElementById('nameInput').value.trim();
            if (!nameInput) {
                showStatus('‚ö†Ô∏è Please enter your name!', 'error');
                setTimeout(() => {
                    document.getElementById('statusMessage').style.display = 'none';
                }, 2000);
                return;
            }
            
            document.getElementById('startButton').disabled = true;
            document.getElementById('startButton').textContent = 'Connecting...';
            
            // Add timeout to prevent hanging
            const timeout = setTimeout(() => {
                console.error('‚è∞ Connection timeout!');
                showStatus('‚è∞ Connection timeout! Please refresh and try again.', 'error');
                document.getElementById('startButton').disabled = false;
                document.getElementById('startButton').textContent = 'Join the Mission';
            }, 10000);
            
            try {
                console.log('üì° Testing Firebase connection...');
                
                // Test Firebase connection first
                await gameRef.child('test').set({ timestamp: Date.now() });
                console.log('‚úÖ Firebase connection successful!');
                
                clearTimeout(timeout);
                
                initWorld();
                console.log('üåç World initialized');
                
                // Generate player ID
                playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                console.log('üë§ Player ID generated:', playerId);
                
                // Create player
                const spawnX = WORLD_SIZE / 2;
                const spawnY = WORLD_SIZE / 2;
                
                player = new Player({
                    id: playerId,
                    name: nameInput,
                    x: spawnX,
                    y: spawnY,
                    color: randomColor(),
                    treesPlanted: 0,
                    pollutionCleaned: 0,
                    solarDeployed: 0,
                    impact: 0
                });
                console.log('üë§ Player created:', player.name);
                
                // Add to Firebase
                console.log('üì§ Sending player data to Firebase...');
                await gameRef.child('players').child(playerId).set({
                    name: player.name,
                    x: player.x,
                    y: player.y,
                    color: player.color,
                    treesPlanted: 0,
                    pollutionCleaned: 0,
                    solarDeployed: 0,
                    impact: 0,
                    lastUpdate: Date.now()
                });
                console.log('‚úÖ Player added to Firebase!');
                
                // Listen for other players
                console.log('üë• Setting up player listener...');
                gameRef.child('players').on('value', (snapshot) => {
                    connectedPlayers = {};
                    snapshot.forEach((child) => {
                        if (child.key !== playerId) {
                            const data = child.val();
                            connectedPlayers[child.key] = new Player({
                                id: child.key,
                                name: data.name,
                                x: data.x,
                                y: data.y,
                                color: data.color,
                                treesPlanted: data.treesPlanted,
                                pollutionCleaned: data.pollutionCleaned,
                                solarDeployed: data.solarDeployed,
                                impact: data.impact
                            });
                        }
                    });
                    updatePlayersList();
                });
                console.log('‚úÖ Player listener active!');
                
                // Listen for trees
                console.log('üå≥ Setting up tree listener...');
                gameRef.child('world/trees').on('value', (snapshot) => {
                    trees = [];
                    snapshot.forEach((child) => {
                        trees.push({ id: child.key, ...child.val() });
                    });
                });
                
                // Listen for pollution
                console.log('üè≠ Setting up pollution listener...');
                gameRef.child('world/pollution').on('value', (snapshot) => {
                    pollution = [];
                    snapshot.forEach((child) => {
                        pollution.push({ id: child.key, ...child.val() });
                    });
                });
                
                // Listen for solar panels
                console.log('‚òÄÔ∏è Setting up solar listener...');
                gameRef.child('world/solar').on('value', (snapshot) => {
                    solarPanels = [];
                    snapshot.forEach((child) => {
                        solarPanels.push({ id: child.key, ...child.val() });
                    });
                });
                
                // Listen for ecosystem health
                console.log('üíö Setting up health listener...');
                gameRef.child('world/health').on('value', (snapshot) => {
                    ecosystemHealth = snapshot.val() || 0;
                    if (ecosystemHealth >= 100) {
                        showStatus('üéâ VICTORY! 100% Ecosystem Health Achieved!', 'success');
                    }
                });
                console.log('‚úÖ All world listeners active!');
                
                // Update position periodically
                console.log('üîÑ Setting up position updates...');
                setInterval(async () => {
                    if (player && gameStarted) {
                        await gameRef.child('players').child(playerId).update({
                            x: player.x,
                            y: player.y,
                            lastUpdate: Date.now()
                        });
                    }
                }, 100);
                
                // Remove player on disconnect
                gameRef.child('players').child(playerId).onDisconnect().remove();
                console.log('üîå Disconnect handler registered');
                
                // Start game
                gameStarted = true;
                console.log('üéÆ Starting game interface...');
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('hud').style.display = 'block';
                document.getElementById('health').style.display = 'block';
                document.getElementById('actionButtons').style.display = 'flex';
                document.getElementById('leaderboard').style.display = 'block';
                document.getElementById('instructionsBtn').style.display = 'block';
                
                // Start pollution spawning
                console.log('üè≠ Starting pollution spawning...');
                startPollutionSpawning();
                
                console.log('‚úÖ Starting game loop...');
                gameLoop();
                
                console.log('üéâ Game fully initialized!');
                showStatus('üåç Welcome to Climate Champions!', 'success');
                setTimeout(() => {
                    document.getElementById('statusMessage').style.display = 'none';
                }, 3000);
                
            } catch (error) {
                clearTimeout(timeout);
                console.error('‚ùå Error initializing game:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                showStatus('‚ùå Connection failed: ' + error.message, 'error');
                document.getElementById('startButton').disabled = false;
                document.getElementById('startButton').textContent = 'Join the Mission';
            }
        }
        
        // Perform action
        async function performAction(action) {
            if (!player || !gameStarted) return;
            
            // Update current action and button states
            currentAction = action;
            document.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('active'));
            
            if (action === 'tree') {
                document.getElementById('treeBtn').classList.add('active');
            } else if (action === 'cleanup') {
                document.getElementById('cleanupBtn').classList.add('active');
            } else if (action === 'solar') {
                document.getElementById('solarBtn').classList.add('active');
            }
            
            const playerGridX = Math.floor(player.x / TILE_SIZE);
            const playerGridY = Math.floor(player.y / TILE_SIZE);
            const tile = getTile(playerGridX, playerGridY);
            
            if (!tile) return;
            
            if (action === 'tree') {
                // Check if tree already exists
                const treeExists = trees.some(t => t.gridX === playerGridX && t.gridY === playerGridY);
                if (treeExists) {
                    showStatus('üö´ Tree already exists here!', 'error');
                    setTimeout(() => {
                        document.getElementById('statusMessage').style.display = 'none';
                    }, 2000);
                    return;
                }
                
                // Check if solar panel exists
                const solarExists = solarPanels.some(s => s.gridX === playerGridX && s.gridY === playerGridY);
                if (solarExists) {
                    showStatus('üö´ Cannot plant tree where solar panel exists!', 'error');
                    setTimeout(() => {
                        document.getElementById('statusMessage').style.display = 'none';
                    }, 2000);
                    return;
                }
                
                // Can't plant on water
                if (tile.type === 'water' || tile.type === 'polluted_water') {
                    showStatus('üö´ Cannot plant trees on water!', 'error');
                    setTimeout(() => {
                        document.getElementById('statusMessage').style.display = 'none';
                    }, 2000);
                    return;
                }
                
                const treeId = `tree_${playerGridX}_${playerGridY}`;
                await gameRef.child('world/trees').child(treeId).set({
                    x: playerGridX * TILE_SIZE + TILE_SIZE/2,
                    y: playerGridY * TILE_SIZE + TILE_SIZE/2,
                    gridX: playerGridX,
                    gridY: playerGridY
                });
                
                player.treesPlanted++;
                player.impact += 5;
                await gameRef.child('players').child(playerId).update({
                    treesPlanted: player.treesPlanted,
                    impact: player.impact
                });
                
                const newHealth = Math.min(100, ecosystemHealth + 5);
                await gameRef.child('world/health').set(newHealth);
                
                showStatus('üå≥ Tree planted!', 'success');
                setTimeout(() => {
                    document.getElementById('statusMessage').style.display = 'none';
                }, 2000);
                
                // Update leaderboard immediately
                updatePlayersList();
            }
            else if (action === 'cleanup') {
                const nearbyPollution = pollution.find(p => {
                    const dx = p.x - player.x;
                    const dy = p.y - player.y;
                    return Math.sqrt(dx*dx + dy*dy) < TILE_SIZE;
                });
                
                if (nearbyPollution) {
                    await gameRef.child('world/pollution').child(nearbyPollution.id).remove();
                    
                    player.pollutionCleaned++;
                    player.impact += 3;
                    await gameRef.child('players').child(playerId).update({
                        pollutionCleaned: player.pollutionCleaned,
                        impact: player.impact
                    });
                    
                    const newHealth = Math.min(100, ecosystemHealth + 3);
                    await gameRef.child('world/health').set(newHealth);
                    
                    showStatus('üßπ Pollution cleaned!', 'success');
                    setTimeout(() => {
                        document.getElementById('statusMessage').style.display = 'none';
                    }, 2000);
                    
                    // Update leaderboard immediately
                    updatePlayersList();
                } else {
                    showStatus('üö´ No pollution nearby!', 'error');
                    setTimeout(() => {
                        document.getElementById('statusMessage').style.display = 'none';
                    }, 2000);
                }
            }
            else if (action === 'solar') {
                // Check if solar panel already exists
                const solarExists = solarPanels.some(s => s.gridX === playerGridX && s.gridY === playerGridY);
                
                if (solarExists) {
                    // REMOVE existing solar panel
                    const solarId = `solar_${playerGridX}_${playerGridY}`;
                    try {
                        await gameRef.child('world/solar').child(solarId).remove();
                        console.log('Solar removed from Firebase:', solarId);
                        showStatus('‚òÄÔ∏è Solar panel removed!', 'success');
                        setTimeout(() => {
                            document.getElementById('statusMessage').style.display = 'none';
                        }, 2000);
                    } catch (error) {
                        console.error('Error removing solar:', error);
                        showStatus('üö´ Error removing solar!', 'error');
                        setTimeout(() => {
                            document.getElementById('statusMessage').style.display = 'none';
                        }, 2000);
                    }
                    return;
                } else {
                    // PLACE a new solar panel
                    // Can't place solar panels on water
                    if (tile.type === 'water' || tile.type === 'polluted_water') {
                        showStatus('üö´ Cannot place solar panels on water!', 'error');
                        setTimeout(() => {
                            document.getElementById('statusMessage').style.display = 'none';
                        }, 2000);
                        return;
                    }
                    
                    // Can't place solar if tree already exists here
                    const treeExists = trees.some(t => t.gridX === playerGridX && t.gridY === playerGridY);
                    if (treeExists) {
                        showStatus('üö´ Cannot place solar panel where tree exists!', 'error');
                        setTimeout(() => {
                            document.getElementById('statusMessage').style.display = 'none';
                        }, 2000);
                        return;
                    }
                    
                    const solarId = `solar_${playerGridX}_${playerGridY}`;
                    await gameRef.child('world/solar').child(solarId).set({
                        x: playerGridX * TILE_SIZE + TILE_SIZE/2,
                        y: playerGridY * TILE_SIZE + TILE_SIZE/2,
                        gridX: playerGridX,
                        gridY: playerGridY
                    });
                    
                    player.solarDeployed++;
                    player.impact += 8;
                    await gameRef.child('players').child(playerId).update({
                        solarDeployed: player.solarDeployed,
                        impact: player.impact
                    });
                    
                    const newHealth = Math.min(100, ecosystemHealth + 0.4);
                    await gameRef.child('world/health').set(newHealth);
                    
                    showStatus('‚òÄÔ∏è Solar panel deployed!', 'success');
                    setTimeout(() => {
                        document.getElementById('statusMessage').style.display = 'none';
                    }, 2000);
                    
                    // Update leaderboard immediately
                    updatePlayersList();
                }
            }
        }
        
        // Update game
        function update() {
            if (!player) return;
            
            const speed = 4;
            if (keys['w'] || keys['W'] || keys['ArrowUp']) player.y -= speed;
            if (keys['s'] || keys['S'] || keys['ArrowDown']) player.y += speed;
            if (keys['a'] || keys['A'] || keys['ArrowLeft']) player.x -= speed;
            if (keys['d'] || keys['D'] || keys['ArrowRight']) player.x += speed;
            
            player.x = Math.max(PLAYER_SIZE, Math.min(WORLD_SIZE - PLAYER_SIZE, player.x));
            player.y = Math.max(PLAYER_SIZE, Math.min(WORLD_SIZE - PLAYER_SIZE, player.y));
            
            // Update camera
            camera.x = player.x - canvas.width / 2;
            camera.y = player.y - canvas.height / 2;
            camera.x = Math.max(0, Math.min(WORLD_SIZE - canvas.width, camera.x));
            camera.y = Math.max(0, Math.min(WORLD_SIZE - canvas.height, camera.y));
            
            // Update UI
            document.getElementById('trees').textContent = player.treesPlanted;
            document.getElementById('cleaned').textContent = player.pollutionCleaned;
            document.getElementById('solar').textContent = player.solarDeployed;
            document.getElementById('impact').textContent = player.impact;
            
            document.getElementById('healthFill').style.width = ecosystemHealth + '%';
            document.getElementById('healthText').textContent = Math.round(ecosystemHealth) + '%';
        }
        
        // Draw game
        function draw() {
            ctx.fillStyle = '#87ceeb';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw tiles
            const startX = Math.floor(camera.x / TILE_SIZE);
            const startY = Math.floor(camera.y / TILE_SIZE);
            const endX = Math.ceil((camera.x + canvas.width) / TILE_SIZE);
            const endY = Math.ceil((camera.y + canvas.height) / TILE_SIZE);
            
            for (let y = startY; y <= endY; y++) {
                for (let x = startX; x <= endX; x++) {
                    const tile = getTile(x, y);
                    if (tile) {
                        ctx.fillStyle = TILE_COLORS[tile.type];
                        ctx.fillRect(
                            x * TILE_SIZE - camera.x,
                            y * TILE_SIZE - camera.y,
                            TILE_SIZE,
                            TILE_SIZE
                        );
                    }
                }
            }
            
            // Draw pollution
            for (let p of pollution) {
                ctx.beginPath();
                ctx.arc(p.x - camera.x, p.y - camera.y, 8, 0, Math.PI * 2);
                ctx.fillStyle = '#1a1a1a';
                ctx.fill();
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            
            // Draw solar panels
            for (let s of solarPanels) {
                ctx.fillStyle = '#1e40af';
                ctx.fillRect(s.x - camera.x - 12, s.y - camera.y - 8, 24, 16);
                ctx.strokeStyle = '#fbbf24';
                ctx.lineWidth = 2;
                ctx.strokeRect(s.x - camera.x - 12, s.y - camera.y - 8, 24, 16);
            }
            
            // Draw trees
            for (let tree of trees) {
                ctx.fillStyle = '#6d4c41';
                ctx.fillRect(tree.x - camera.x - 3, tree.y - camera.y, 6, 15);
                ctx.beginPath();
                ctx.arc(tree.x - camera.x, tree.y - camera.y - 5, 12, 0, Math.PI * 2);
                ctx.fillStyle = '#2e7d32';
                ctx.fill();
            }
            
            // Draw players
            if (player) player.draw();
            Object.values(connectedPlayers).forEach(p => p.draw());
        }
        
        // Game loop
        function gameLoop() {
            if (!gameStarted) return;
            
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        // Event listeners
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            
            // Close instructions with Escape
            if (e.key === 'Escape') {
                hideInstructions();
            }
            
            if (e.key === '1' || e.key === 't' || e.key === 'T') {
                performAction('tree');
            } else if (e.key === '2' || e.key === 'c' || e.key === 'C') {
                performAction('cleanup');
            } else if (e.key === '3' || e.key === 's' || e.key === 'S') {
                performAction('solar');
            } else if (e.key === ' ') {
                e.preventDefault();
                performAction(currentAction);
            }
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });
        
        // Close instructions when clicking outside
        document.getElementById('instructionsModal').addEventListener('click', (e) => {
            if (e.target.id === 'instructionsModal') {
                hideInstructions();
            }
        });
        
        // Button event listeners
        document.getElementById('treeBtn').addEventListener('click', () => performAction('tree'));
        document.getElementById('cleanupBtn').addEventListener('click', () => performAction('cleanup'));
        document.getElementById('solarBtn').addEventListener('click', () => performAction('solar'));
        document.getElementById('instructionsBtn').addEventListener('click', showInstructions);
        
        document.getElementById('startButton').addEventListener('click', init);
        document.getElementById('nameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') init();
        });
        
        document.getElementById('nameInput').focus();
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopPollutionSpawning();
        });
        
        } // End of setupGame function
        
        // Start the game
        setupGame();
    </script>

    <!-- Visitor Counter (non-intrusive, fixed bottom-left) -->
    <div style="position:fixed;bottom:10px;left:10px;font:14px/1.2 system-ui,Segoe UI,Tahoma,Arial;color:#e5e7eb;background:rgba(0,0,0,.6);padding:6px 10px;border:1px solid #4ade80;border-radius:8px;backdrop-filter:blur(6px);z-index:9999">
      Visitor Counter:
      <img src="https://visitor-badge.laobi.icu/badge?page_id=jeanmhuang.multiplayer" alt="Visitors" style="vertical-align:middle">
    </div>
</body>
</html>
