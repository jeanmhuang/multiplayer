<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Champions - Real Multiplayer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            background: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #gameCanvas {
            display: block;
        }
        
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
        }
        
        #startScreen h1 {
            font-size: 64px;
            margin-bottom: 10px;
            color: #4ade80;
            text-shadow: 0 0 30px rgba(74, 222, 128, 0.5);
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 20px;
            color: #93c5fd;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .multiplayer-badge {
            background: rgba(74, 222, 128, 0.2);
            padding: 10px 20px;
            border-radius: 20px;
            border: 2px solid #4ade80;
            margin-bottom: 30px;
            font-size: 16px;
            font-weight: bold;
            color: #4ade80;
        }
        
        .mission {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 15px;
            max-width: 600px;
            margin-bottom: 30px;
            border: 2px solid rgba(74, 222, 128, 0.3);
        }
        
        .mission h3 {
            color: #4ade80;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .mission ul {
            list-style: none;
            padding: 0;
        }
        
        .mission li {
            padding: 8px 0;
            padding-left: 30px;
            position: relative;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .mission li:before {
            content: "üåç";
            position: absolute;
            left: 0;
        }
        
        #nameInput {
            padding: 15px 25px;
            font-size: 18px;
            border: 3px solid #4ade80;
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a1a;
            border-radius: 10px;
            margin-bottom: 20px;
            width: 350px;
            text-align: center;
            font-weight: 600;
        }
        
        #nameInput:focus {
            outline: none;
            box-shadow: 0 0 30px rgba(74, 222, 128, 0.6);
        }
        
        #startButton {
            padding: 18px 60px;
            font-size: 26px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(74, 222, 128, 0.4);
        }
        
        #startButton:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(74, 222, 128, 0.6);
        }
        
        #startButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-message {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            padding: 15px 30px;
            background: rgba(251, 191, 36, 0.95);
            border: 2px solid #fbbf24;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.95);
            border-color: #ef4444;
            color: white;
        }
        
        .success-message {
            background: rgba(74, 222, 128, 0.95);
            border-color: #4ade80;
            color: black;
        }
        
        .controls {
            margin-top: 20px;
            color: #cbd5e1;
            font-size: 14px;
            text-align: center;
        }
        
        .controls div {
            margin: 6px 0;
        }
        
        .toggle-setup {
            margin-top: 15px;
            padding: 12px 24px;
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid #3b82f6;
            color: #3b82f6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .toggle-setup:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.75);
            padding: 20px;
            border-radius: 12px;
            border: 3px solid #4ade80;
            min-width: 220px;
            backdrop-filter: blur(10px);
        }
        
        #hud h3 {
            color: #4ade80;
            margin-bottom: 12px;
            font-size: 18px;
            border-bottom: 2px solid #4ade80;
            padding-bottom: 8px;
        }
        
        #hud .stat {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
        }
        
        #hud .stat-label {
            color: #93c5fd;
        }
        
        #hud .stat-value {
            font-weight: bold;
            color: #4ade80;
            font-size: 17px;
        }
        
        #onlinePlayers {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.75);
            padding: 20px;
            border-radius: 12px;
            border: 3px solid #4ade80;
            color: white;
            min-width: 240px;
            backdrop-filter: blur(10px);
        }
        
        #onlinePlayers h3 {
            margin-bottom: 12px;
            text-align: center;
            color: #4ade80;
            border-bottom: 2px solid #4ade80;
            padding-bottom: 8px;
            font-size: 18px;
        }
        
        .player-entry {
            padding: 8px;
            margin: 6px 0;
            font-size: 14px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-entry.you {
            background: rgba(74, 222, 128, 0.25);
            font-weight: bold;
            border: 2px solid #4ade80;
        }
        
        .player-status {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #impactMeter {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            background: rgba(0, 0, 0, 0.75);
            padding: 15px 20px;
            border-radius: 12px;
            border: 3px solid #4ade80;
            backdrop-filter: blur(10px);
        }
        
        #impactMeter h4 {
            color: #4ade80;
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
        }
        
        .meter-bar {
            width: 100%;
            height: 25px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 2px solid #333;
        }
        
        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #4ade80);
            transition: width 0.5s;
            border-radius: 10px;
        }
        
        .meter-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 13px;
            text-shadow: 1px 1px 3px black;
        }
        
        #actions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            padding: 15px 25px;
            border-radius: 12px;
            border: 3px solid #4ade80;
            color: white;
            backdrop-filter: blur(10px);
            display: flex;
            gap: 15px;
        }
        
        .action-button {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 120px;
            background-color: transparent;
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .action-button.tree {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #22c55e;
        }
        
        .action-button.cleanup {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .action-button.solar {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
            color: #fbbf24;
        }
        
        .action-icon {
            font-size: 24px;
        }
        
        .action-label {
            font-size: 12px;
        }
        
        #instructionsBtn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background: rgba(59, 130, 246, 0.8);
            color: white;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            font-size: 14px;
        }
        
        #instructionsBtn:hover {
            background: rgba(59, 130, 246, 1);
            transform: translateY(-2px);
        }
        
        #instructionsModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .instructions-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #4ade80;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            color: white;
        }
        
        .instructions-content h2 {
            color: #4ade80;
            margin-bottom: 20px;
            font-size: 32px;
            text-align: center;
        }
        
        .instructions-section {
            margin: 25px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border-left: 4px solid #4ade80;
        }
        
        .instructions-section h3 {
            color: #93c5fd;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .instructions-section p {
            line-height: 1.8;
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .control-key {
            background: #4ade80;
            color: black;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            margin-right: 15px;
            min-width: 80px;
            text-align: center;
            font-family: 'Courier New', monospace;
        }
        
        .control-desc {
            flex: 1;
        }
        
        .close-instructions {
            display: block;
            margin: 30px auto 0;
            padding: 15px 40px;
            background: #4ade80;
            color: black;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .close-instructions:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(74, 222, 128, 0.5);
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="startScreen">
        <h1>üåç CLIMATE CHAMPIONS üåç</h1>
        <div class="subtitle">Real-Time Multiplayer Climate Action</div>
        <div class="multiplayer-badge">üåê PLAY WITH FRIENDS WORLDWIDE</div>
        
        <div class="mission">
            <h3>YOUR MISSION:</h3>
            <ul>
                <li>Plant trees to absorb CO‚ÇÇ and restore forests</li>
                <li>Clean up pollution from land and water</li>
                <li>Deploy solar panels for renewable energy</li>
                <li>Compete with other champions to heal the Earth!</li>
            </ul>
        </div>
        
        <input type="text" id="nameInput" placeholder="Enter Champion Name" maxlength="12">
        <button id="startButton">JOIN GAME</button>
        <button class="toggle-setup" onclick="showInstructions()">üìñ HOW TO PLAY</button>
        
        <div class="controls">
            <div>üéÆ <strong>WASD / Arrow Keys</strong> - Move your champion</div>
            <div>üå≥ <strong>Press T or 1</strong> (or click button) - Plant Tree</div>
            <div>üßπ <strong>Press C or 2</strong> (or click button) - Clean Pollution</div>
            <div>‚òÄÔ∏è <strong>Press S or 3</strong> (or click button) - Deploy Solar</div>
            <div>üñ±Ô∏è <strong>Double-Click</strong> - Remove tree or solar panel</div>
        </div>
    </div>
    
    <div id="hud" style="display: none;">
        <h3>üåø YOUR STATS</h3>
        <div class="stat">
            <span class="stat-label">üå≥ Trees:</span>
            <span class="stat-value" id="trees">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">üßπ Cleaned:</span>
            <span class="stat-value" id="cleaned">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">‚òÄÔ∏è Solar:</span>
            <span class="stat-value" id="solar">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">‚≠ê Impact:</span>
            <span class="stat-value" id="impact">0</span>
        </div>
    </div>
    
    <div id="impactMeter" style="display: none;">
        <h4>üåç GLOBAL ECOSYSTEM HEALTH</h4>
        <div class="meter-bar">
            <div class="meter-fill" id="healthFill" style="width: 30%;"></div>
            <div class="meter-text" id="healthText">30%</div>
        </div>
    </div>
    
    <div id="onlinePlayers" style="display: none;">
        <h3>üë• ONLINE CHAMPIONS</h3>
        <div id="playersList"></div>
    </div>
    
    <div id="actions" style="display: none;">
        <button class="action-button tree" id="treeBtn">
            <span class="action-icon">üå≥</span>
            <span class="action-label">TREE (T or 1)</span>
        </button>
        <button class="action-button cleanup" id="cleanupBtn">
            <span class="action-icon">üßπ</span>
            <span class="action-label">CLEAN (C or 2)</span>
        </button>
        <button class="action-button solar" id="solarBtn">
            <span class="action-icon">‚òÄÔ∏è</span>
            <span class="action-label">SOLAR (S or 3)</span>
        </button>
    </div>
    
    <button id="instructionsBtn" style="display: none;">üìñ HOW TO PLAY</button>
    
    <div id="statusMessage" style="display: none;"></div>
    
    <div id="instructionsModal">
        <div class="instructions-content">
            <h2>üåç HOW TO PLAY CLIMATE CHAMPIONS</h2>
            
            <div class="instructions-section">
                <h3>üéØ YOUR MISSION</h3>
                <p>Work together with other players around the world to restore Earth's ecosystem! Plant trees, clean pollution, and deploy renewable energy to increase the Global Ecosystem Health to 100%.</p>
            </div>
            
            <div class="instructions-section">
                <h3>üéÆ CONTROLS</h3>
                <div class="control-item">
                    <div class="control-key">W A S D</div>
                    <div class="control-desc">Move your champion around the map</div>
                </div>
                <div class="control-item">
                    <div class="control-key">‚Üë ‚Üê ‚Üì ‚Üí</div>
                    <div class="control-desc">Alternative movement controls (Arrow keys)</div>
                </div>
            </div>
            
            <div class="instructions-section">
                <h3>üå± ACTIONS (Choose One Method)</h3>
                <p style="margin-bottom: 15px;"><strong>You can perform actions in TWO ways - pick whichever you prefer:</strong></p>
                
                <p><strong>Method 1: Keyboard Shortcuts</strong></p>
                <div class="control-item">
                    <div class="control-key">T or 1</div>
                    <div class="control-desc">üå≥ <strong>Plant Tree</strong> - Absorbs CO‚ÇÇ and restores forests (+10 impact, +0.5% health)</div>
                </div>
                <div class="control-item">
                    <div class="control-key">C or 2</div>
                    <div class="control-desc">üßπ <strong>Clean Pollution</strong> - Remove pollution from land and water (+15 impact, +0.8% health)</div>
                </div>
                <div class="control-item">
                    <div class="control-key">S or 3</div>
                    <div class="control-desc">‚òÄÔ∏è <strong>Deploy Solar Panel</strong> - Generate renewable energy (+8 impact, +0.4% health)</div>
                </div>
                
                <p style="margin-top: 15px;"><strong>Method 2: Click Buttons</strong></p>
                <div class="control-item">
                    <div class="control-key">CLICK</div>
                    <div class="control-desc">Click the action buttons at the bottom of the screen to perform actions</div>
                </div>
                
                <p style="margin-top: 15px; font-style: italic; color: #93c5fd;">üí° Tip: Walk to where you want to perform the action, then either press the key or click the button!</p>
            </div>
            
            <div class="instructions-section">
                <h3>üóëÔ∏è REMOVING ITEMS</h3>
                <div class="control-item">
                    <div class="control-key">DOUBLE-CLICK</div>
                    <div class="control-desc">Remove any tree or solar panel by double-clicking on it. Perfect for fixing mistakes or clearing items placed on water!</div>
                </div>
                <p style="margin-top: 10px; color: #93c5fd;">Note: You can remove ANY tree or solar panel, even ones placed by other players.</p>
            </div>
            
            <div class="instructions-section">
                <h3>üìä GAMEPLAY TIPS</h3>
                <p><strong>üßπ Clean Pollution First:</strong> Gives the most impact points and ecosystem health boost.</p>
                <p><strong>üå≥ Plant Trees Strategically:</strong> Trees can't overlap - spread them out. Trees can only be planted on land (not water!).</p>
                <p><strong>‚òÄÔ∏è Solar Panels:</strong> Place on land tiles only (not water or where trees already exist).</p>
                <p><strong>üíß Water Tiles:</strong> The blue squares are water - you can't build on them, but you can clean pollution from them!</p>
                <p><strong>üñ±Ô∏è Double-Click to Remove:</strong> Made a mistake? Double-click any tree or solar panel to remove it!</p>
                <p><strong>üèÜ Compete & Cooperate:</strong> Race to the top of the leaderboard while helping heal the planet together!</p>
                <p><strong>üë• Multiplayer:</strong> You'll see other players in real-time. Their actions affect the shared world!</p>
            </div>
            
            <div class="instructions-section">
                <h3>üéØ WINNING THE GAME</h3>
                <p>The goal is to increase the <strong>Global Ecosystem Health</strong> (shown at the top center) from 30% to 100%. Every positive action you and other players take contributes to this shared goal. Work together to save the planet! üåç</p>
            </div>
            
            <button class="close-instructions" onclick="hideInstructions()">GOT IT! LET'S PLAY</button>
        </div>
    </div>

    <!-- Firebase SDK - Updated to latest stable version -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Show status message - defined globally
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            if (!statusEl) return;
            statusEl.textContent = message;
            statusEl.className = 'status-message';
            if (type === 'error') statusEl.classList.add('error-message');
            if (type === 'success') statusEl.classList.add('success-message');
            statusEl.style.display = 'block';
        }
        
        // Show/hide instructions - defined globally
        function showInstructions() {
            document.getElementById('instructionsModal').style.display = 'flex';
        }
        
        function hideInstructions() {
            document.getElementById('instructionsModal').style.display = 'none';
        }
        
        let retryCount = 0;
        const maxRetries = 10;
        
        // Wait for Firebase to load
        window.addEventListener('load', function() {
            initializeApp();
        });
        
        function initializeApp() {
            retryCount++;
            
            // Check if Firebase loaded
            if (typeof firebase === 'undefined') {
                if (retryCount >= maxRetries) {
                    const errorMsg = document.getElementById('statusMessage');
                    errorMsg.innerHTML = `
                        <strong>‚ö†Ô∏è Firebase Failed to Load</strong><br><br>
                        <strong>Troubleshooting:</strong><br>
                        1. Check your internet connection<br>
                        2. Disable ad blockers (they often block Firebase)<br>
                        3. Try a different browser<br>
                        4. Check if firewall is blocking Google CDN<br>
                        5. Press Ctrl+Shift+R (or Cmd+Shift+R) to hard refresh<br><br>
                        <strong>Still not working?</strong> Open browser console (F12) to see detailed errors.
                    `;
                    errorMsg.className = 'status-message error-message';
                    errorMsg.style.display = 'block';
                    console.error('Firebase failed to load after ' + maxRetries + ' attempts.');
                    console.error('Possible causes:');
                    console.error('1) Ad blocker blocking Firebase CDN');
                    console.error('2) Firewall blocking googleapis.com or gstatic.com');
                    console.error('3) No internet connection');
                    console.error('4) Browser extension interfering');
                    return;
                }
                
                showStatus(`Loading Firebase... (${retryCount}/${maxRetries})`, 'info');
                setTimeout(initializeApp, 500);
                return;
            }
            
            showStatus('', 'success');
            document.getElementById('statusMessage').style.display = 'none';
            setupGame();
        }
        
        function setupGame() {
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        
        // Firebase configuration - HARDCODED
        const firebaseConfig = {
            apiKey: "AIzaSyDnec7-hhj7kcxlS3HOrRGdP3VgOxAeEXY",
            databaseURL: "https://climate-champions-8e318-default-rtdb.firebaseio.com"
        };
        
        // Initialize Firebase
        let database, gameRef;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            gameRef = database.ref('game');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showStatus('Firebase connection failed: ' + error.message, 'error');
            return;
        }
        
        // Firebase and multiplayer state
        let playerId = null;
        let connectedPlayers = {};
        
        // Game constants
        const WORLD_SIZE = 3500;
        const TILE_SIZE = 50;
        const PLAYER_SIZE = 20;
        
        // Game state
        let gameStarted = false;
        let keys = {};
        let camera = { x: 0, y: 0 };
        let currentAction = 'tree';
        let ecosystemHealth = 30;
        
        // Game objects
        let player = null;
        let tiles = [];
        let pollution = [];
        let trees = [];
        let solarPanels = [];
        let particles = [];
        
        // Colors
        const TILE_COLORS = {
            dirt: '#8b7355',
            grass: '#7cb342',
            forest: '#2e7d32',
            water: '#1976d2',
            polluted_water: '#424242',
            polluted_land: '#4a4a4a'
        };
        
        const PLAYER_COLORS = ['#4ade80', '#10b981', '#059669', '#84cc16', '#22d3ee', '#06b6d4', '#8b5cf6', '#a855f7'];
        
        // Champion class
        class Champion {
            constructor(id, data) {
                this.id = id;
                this.x = data.x || WORLD_SIZE / 2;
                this.y = data.y || WORLD_SIZE / 2;
                this.name = data.name || 'Champion';
                this.color = data.color || '#4ade80';
                this.treesPlanted = data.treesPlanted || 0;
                this.pollutionCleaned = data.pollutionCleaned || 0;
                this.solarDeployed = data.solarDeployed || 0;
                this.impact = data.impact || 0;
                this.lastUpdate = data.lastUpdate || Date.now();
            }
            
            draw() {
                ctx.save();
                ctx.translate(this.x - camera.x, this.y - camera.y);
                
                // Draw champion body
                ctx.beginPath();
                ctx.arc(0, 0, PLAYER_SIZE, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Draw icon
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.id === playerId ? 'üåü' : 'üåø', 0, 0);
                
                ctx.restore();
                
                // Draw name
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 13px Arial';
                ctx.textAlign = 'center';
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.strokeText(this.name, this.x - camera.x, this.y - camera.y - PLAYER_SIZE - 10);
                ctx.fillText(this.name, this.x - camera.x, this.y - camera.y - PLAYER_SIZE - 10);
            }
        }
        
        // Tile system
        function initTiles() {
            const cols = Math.ceil(WORLD_SIZE / TILE_SIZE);
            const rows = Math.ceil(WORLD_SIZE / TILE_SIZE);
            
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    let type = 'grass';
                    const rand = Math.random();
                    
                    if (rand < 0.15) type = 'water';
                    else if (rand < 0.25) type = 'dirt';
                    else if (rand < 0.35) type = 'forest';
                    
                    tiles.push({ x, y, type });
                }
            }
        }
        
        function getTile(x, y) {
            const cols = Math.ceil(WORLD_SIZE / TILE_SIZE);
            return tiles[y * cols + x];
        }
        
        // Initialize game
        async function init() {
            const playerName = document.getElementById('nameInput').value.trim() || 'Champion';
            
            try {
                showStatus('Connecting to game...', 'info');
                
                // Generate player ID
                playerId = 'player_' + Math.random().toString(36).substr(2, 9);
                
                // Get a unique color
                const colorIndex = Object.keys(connectedPlayers).length % PLAYER_COLORS.length;
                const playerColor = PLAYER_COLORS[colorIndex];
                
                // Initialize world
                initTiles();
                
                // Add player to database
                const playerData = {
                    name: playerName,
                    color: playerColor,
                    x: WORLD_SIZE / 2 + (Math.random() - 0.5) * 200,
                    y: WORLD_SIZE / 2 + (Math.random() - 0.5) * 200,
                    treesPlanted: 0,
                    pollutionCleaned: 0,
                    solarDeployed: 0,
                    impact: 0,
                    lastUpdate: Date.now()
                };
                
                await gameRef.child('players').child(playerId).set(playerData);
                
                player = new Champion(playerId, playerData);
                
                // Set up presence system
                const playerRef = gameRef.child('players').child(playerId);
                playerRef.onDisconnect().remove();
                
                // Listen for other players
                gameRef.child('players').on('child_added', (snapshot) => {
                    const id = snapshot.key;
                    const data = snapshot.val();
                    if (id !== playerId) {
                        connectedPlayers[id] = new Champion(id, data);
                    }
                    // Always update list when any player is added
                    setTimeout(() => updatePlayersList(), 100);
                });
                
                gameRef.child('players').on('child_changed', (snapshot) => {
                    const id = snapshot.key;
                    const data = snapshot.val();
                    if (id === playerId) {
                        // Update our own player data
                        player.impact = data.impact;
                        player.treesPlanted = data.treesPlanted;
                        player.pollutionCleaned = data.pollutionCleaned;
                        player.solarDeployed = data.solarDeployed;
                    } else if (connectedPlayers[id]) {
                        connectedPlayers[id] = new Champion(id, data);
                    }
                    updatePlayersList();
                });
                
                gameRef.child('players').on('child_removed', (snapshot) => {
                    const id = snapshot.key;
                    delete connectedPlayers[id];
                    updatePlayersList();
                });
                
                // Listen for shared world state
                gameRef.child('world/pollution').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        pollution = Object.values(data);
                    }
                });
                
                gameRef.child('world/trees').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        trees = Object.values(data);
                    }
                });
                
                gameRef.child('world/solar').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        solarPanels = Object.values(data);
                    }
                });
                
                gameRef.child('world/health').on('value', (snapshot) => {
                    const health = snapshot.val();
                    if (health !== null) {
                        ecosystemHealth = health;
                    }
                });
                
                // Initialize world state if first player
                const worldSnapshot = await gameRef.child('world').once('value');
                if (!worldSnapshot.exists()) {
                    // Initialize pollution
                    const pollutionData = {};
                    for (let i = 0; i < 50; i++) {
                        const id = 'pollution_' + i;
                        pollutionData[id] = {
                            x: Math.random() * WORLD_SIZE,
                            y: Math.random() * WORLD_SIZE
                        };
                    }
                    await gameRef.child('world/pollution').set(pollutionData);
                    await gameRef.child('world/health').set(30);
                }
                
                gameStarted = true;
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('hud').style.display = 'block';
                document.getElementById('impactMeter').style.display = 'block';
                document.getElementById('onlinePlayers').style.display = 'block';
                document.getElementById('actions').style.display = 'flex';
                document.getElementById('instructionsBtn').style.display = 'block';
                
                showStatus('Connected!', 'success');
                setTimeout(() => {
                    document.getElementById('statusMessage').style.display = 'none';
                }, 2000);
                
                // Update player list immediately to show current player
                updatePlayersList();
                
                // Try again after a short delay to ensure Firebase events have fired
                setTimeout(() => updatePlayersList(), 500);
                setTimeout(() => updatePlayersList(), 1500);
                
                // Start sending position updates
                setInterval(updatePlayerPosition, 50);
                
                // Update player list every second to keep it fresh
                setInterval(updatePlayersList, 1000);
                
                gameLoop();
            } catch (error) {
                showStatus('Connection error: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // Update player position in database
        function updatePlayerPosition() {
            if (player && database) {
                gameRef.child('players').child(playerId).update({
                    x: player.x,
                    y: player.y,
                    lastUpdate: Date.now()
                });
            }
        }
        
        // Update players list
        function updatePlayersList() {
            const listEl = document.getElementById('playersList');
            
            if (!listEl) {
                return;
            }
            
            listEl.innerHTML = '';
            
            // Make sure we have a player before trying to show the list
            if (!player) {
                listEl.innerHTML = '<div style="text-align: center; color: #ccc; padding: 10px;">Waiting for player...</div>';
                return;
            }
            
            const allPlayers = [player, ...Object.values(connectedPlayers)]
                .filter(p => p && p.name) // Make sure player exists and has a name
                .sort((a, b) => (b.impact || 0) - (a.impact || 0));
            
            if (allPlayers.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; color: #666; padding: 10px;">Loading...</div>';
                return;
            }
            
            allPlayers.forEach(p => {
                const entry = document.createElement('div');
                entry.className = 'player-entry' + (p.id === playerId ? ' you' : '');
                entry.innerHTML = `
                    <span><span class="player-status"></span>${p.name}</span>
                    <span>${p.impact || 0}</span>
                `;
                listEl.appendChild(entry);
            });
        }
        
        // Perform action
        async function performAction(action) {
            if (!player || !database) return;
            
            const gridX = Math.floor(player.x / TILE_SIZE);
            const gridY = Math.floor(player.y / TILE_SIZE);
            const tile = getTile(gridX, gridY);
            
            if (!tile) return;
            
            if (action === 'tree') {
                // Can't plant trees on water
                if (tile.type === 'water' || tile.type === 'polluted_water') {
                    showStatus('üö´ Cannot plant trees on water!', 'error');
                    setTimeout(() => {
                        document.getElementById('statusMessage').style.display = 'none';
                    }, 2000);
                    return;
                }
                
                const treeId = `tree_${gridX}_${gridY}`;
                const exists = trees.some(t => t.gridX === gridX && t.gridY === gridY);
                if (!exists) {
                    await gameRef.child('world/trees').child(treeId).set({
                        x: gridX * TILE_SIZE + TILE_SIZE/2,
                        y: gridY * TILE_SIZE + TILE_SIZE/2,
                        gridX, gridY,
                        age: 0
                    });
                    
                    player.treesPlanted++;
                    player.impact += 10;
                    await gameRef.child('players').child(playerId).update({
                        treesPlanted: player.treesPlanted,
                        impact: player.impact
                    });
                    
                    const newHealth = Math.min(100, ecosystemHealth + 0.5);
                    await gameRef.child('world/health').set(newHealth);
                    
                    // Update leaderboard immediately
                    updatePlayersList();
                } else {
                    showStatus('üö´ Tree already planted here!', 'error');
                    setTimeout(() => {
                        document.getElementById('statusMessage').style.display = 'none';
                    }, 2000);
                }
            } else if (action === 'cleanup') {
                for (let p of pollution) {
                    if (Math.hypot(p.x - player.x, p.y - player.y) < 40) {
                        // Remove from database
                        const pollutionSnapshot = await gameRef.child('world/pollution').once('value');
                        const pollutionData = pollutionSnapshot.val() || {};
                        
                        for (let [key, value] of Object.entries(pollutionData)) {
                            if (Math.abs(value.x - p.x) < 1 && Math.abs(value.y - p.y) < 1) {
                                await gameRef.child('world/pollution').child(key).remove();
                                break;
                            }
                        }
                        
                        player.pollutionCleaned++;
                        player.impact += 15;
                        await gameRef.child('players').child(playerId).update({
                            pollutionCleaned: player.pollutionCleaned,
                            impact: player.impact
                        });
                        
                        const newHealth = Math.min(100, ecosystemHealth + 0.8);
                        await gameRef.child('world/health').set(newHealth);
                        
                        // Update leaderboard immediately
                        updatePlayersList();
                        return;
                    }
                }
                
                // No pollution nearby
                showStatus('üö´ No pollution nearby to clean!', 'error');
                setTimeout(() => {
                    document.getElementById('statusMessage').style.display = 'none';
                }, 2000);
                
            } else if (action === 'solar') {
                // Can't place solar panels on water
                if (tile.type === 'water' || tile.type === 'polluted_water') {
                    showStatus('üö´ Cannot place solar panels on water!', 'error');
                    setTimeout(() => {
                        document.getElementById('statusMessage').style.display = 'none';
                    }, 2000);
                    return;
                }
                
                const solarId = `solar_${gridX}_${gridY}`;
                const exists = solarPanels.some(s => s.gridX === gridX && s.gridY === gridY);
                const treeExists = trees.some(t => t.gridX === gridX && t.gridY === gridY);
                
                if (treeExists) {
                    showStatus('üö´ Cannot place solar panel on a tree!', 'error');
                    setTimeout(() => {
                        document.getElementById('statusMessage').style.display = 'none';
                    }, 2000);
                    return;
                }
                
                if (!exists) {
                    await gameRef.child('world/solar').child(solarId).set({
                        x: gridX * TILE_SIZE + TILE_SIZE/2,
                        y: gridY * TILE_SIZE + TILE_SIZE/2,
                        gridX, gridY
                    });
                    
                    player.solarDeployed++;
                    player.impact += 8;
                    await gameRef.child('players').child(playerId).update({
                        solarDeployed: player.solarDeployed,
                        impact: player.impact
                    });
                    
                    const newHealth = Math.min(100, ecosystemHealth + 0.4);
                    await gameRef.child('world/health').set(newHealth);
                    
                    // Update leaderboard immediately
                    updatePlayersList();
                } else {
                    showStatus('üö´ Solar panel already placed here!', 'error');
                    setTimeout(() => {
                        document.getElementById('statusMessage').style.display = 'none';
                    }, 2000);
                }
            }
        }
        
        // Update game
        function update() {
            if (!player) return;
            
            const speed = 4;
            if (keys['w'] || keys['W'] || keys['ArrowUp']) player.y -= speed;
            if (keys['s'] || keys['S'] || keys['ArrowDown']) player.y += speed;
            if (keys['a'] || keys['A'] || keys['ArrowLeft']) player.x -= speed;
            if (keys['d'] || keys['D'] || keys['ArrowRight']) player.x += speed;
            
            player.x = Math.max(PLAYER_SIZE, Math.min(WORLD_SIZE - PLAYER_SIZE, player.x));
            player.y = Math.max(PLAYER_SIZE, Math.min(WORLD_SIZE - PLAYER_SIZE, player.y));
            
            // Update camera
            camera.x = player.x - canvas.width / 2;
            camera.y = player.y - canvas.height / 2;
            camera.x = Math.max(0, Math.min(WORLD_SIZE - canvas.width, camera.x));
            camera.y = Math.max(0, Math.min(WORLD_SIZE - canvas.height, camera.y));
            
            // Update UI
            document.getElementById('trees').textContent = player.treesPlanted;
            document.getElementById('cleaned').textContent = player.pollutionCleaned;
            document.getElementById('solar').textContent = player.solarDeployed;
            document.getElementById('impact').textContent = player.impact;
            
            document.getElementById('healthFill').style.width = ecosystemHealth + '%';
            document.getElementById('healthText').textContent = Math.round(ecosystemHealth) + '%';
        }
        
        // Draw game
        function draw() {
            ctx.fillStyle = '#87ceeb';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw tiles
            const startX = Math.floor(camera.x / TILE_SIZE);
            const startY = Math.floor(camera.y / TILE_SIZE);
            const endX = Math.ceil((camera.x + canvas.width) / TILE_SIZE);
            const endY = Math.ceil((camera.y + canvas.height) / TILE_SIZE);
            
            for (let y = startY; y <= endY; y++) {
                for (let x = startX; x <= endX; x++) {
                    const tile = getTile(x, y);
                    if (tile) {
                        ctx.fillStyle = TILE_COLORS[tile.type];
                        ctx.fillRect(
                            x * TILE_SIZE - camera.x,
                            y * TILE_SIZE - camera.y,
                            TILE_SIZE,
                            TILE_SIZE
                        );
                    }
                }
            }
            
            // Draw pollution
            for (let p of pollution) {
                ctx.beginPath();
                ctx.arc(p.x - camera.x, p.y - camera.y, 8, 0, Math.PI * 2);
                ctx.fillStyle = '#1a1a1a';
                ctx.fill();
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            
            // Draw solar panels
            for (let s of solarPanels) {
                ctx.fillStyle = '#1e40af';
                ctx.fillRect(s.x - camera.x - 12, s.y - camera.y - 8, 24, 16);
                ctx.strokeStyle = '#fbbf24';
                ctx.lineWidth = 2;
                ctx.strokeRect(s.x - camera.x - 12, s.y - camera.y - 8, 24, 16);
            }
            
            // Draw trees
            for (let tree of trees) {
                ctx.fillStyle = '#6d4c41';
                ctx.fillRect(tree.x - camera.x - 3, tree.y - camera.y, 6, 15);
                ctx.beginPath();
                ctx.arc(tree.x - camera.x, tree.y - camera.y - 5, 12, 0, Math.PI * 2);
                ctx.fillStyle = '#2e7d32';
                ctx.fill();
            }
            
            // Draw players
            if (player) player.draw();
            Object.values(connectedPlayers).forEach(p => p.draw());
        }
        
        // Game loop
        function gameLoop() {
            if (!gameStarted) return;
            
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        // Event listeners
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            
            // Close instructions with Escape
            if (e.key === 'Escape') {
                hideInstructions();
            }
            
            if (e.key === '1' || e.key === 't' || e.key === 'T') {
                performAction('tree');
            } else if (e.key === '2' || e.key === 'c' || e.key === 'C') {
                performAction('cleanup');
            } else if (e.key === '3' || e.key === 's' || e.key === 'S') {
                performAction('solar');
            } else if (e.key === ' ') {
                e.preventDefault();
                performAction(currentAction);
            }
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });
        
        // Close instructions when clicking outside
        document.getElementById('instructionsModal').addEventListener('click', (e) => {
            if (e.target.id === 'instructionsModal') {
                hideInstructions();
            }
        });
        
        // Double-click to remove trees and solar panels
        canvas.addEventListener('dblclick', async (e) => {
            if (!gameStarted || !player) return;
            
            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left + camera.x;
            const clickY = e.clientY - rect.top + camera.y;
            
            // Check if clicked on a tree
            for (let tree of trees) {
                const distance = Math.hypot(tree.x - clickX, tree.y - clickY);
                if (distance < 20) {
                    // Remove tree from database
                    const treeSnapshot = await gameRef.child('world/trees').once('value');
                    const treeData = treeSnapshot.val() || {};
                    
                    for (let [key, value] of Object.entries(treeData)) {
                        if (Math.abs(value.x - tree.x) < 1 && Math.abs(value.y - tree.y) < 1) {
                            await gameRef.child('world/trees').child(key).remove();
                            showStatus('üå≥ Tree removed!', 'success');
                            setTimeout(() => {
                                document.getElementById('statusMessage').style.display = 'none';
                            }, 2000);
                            return;
                        }
                    }
                }
            }
            
            // Check if clicked on a solar panel
            for (let solar of solarPanels) {
                const distance = Math.hypot(solar.x - clickX, solar.y - clickY);
                if (distance < 20) {
                    // Remove solar panel from database
                    const solarSnapshot = await gameRef.child('world/solar').once('value');
                    const solarData = solarSnapshot.val() || {};
                    
                    for (let [key, value] of Object.entries(solarData)) {
                        if (Math.abs(value.x - solar.x) < 1 && Math.abs(value.y - solar.y) < 1) {
                            await gameRef.child('world/solar').child(key).remove();
                            showStatus('‚òÄÔ∏è Solar panel removed!', 'success');
                            setTimeout(() => {
                                document.getElementById('statusMessage').style.display = 'none';
                            }, 2000);
                            return;
                        }
                    }
                }
            }
        });
        
        // Change cursor when hovering over removable items
        canvas.addEventListener('mousemove', (e) => {
            if (!gameStarted || !player) return;
            
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left + camera.x;
            const mouseY = e.clientY - rect.top + camera.y;
            
            let overRemovableItem = false;
            
            // Check if hovering over a tree
            for (let tree of trees) {
                const distance = Math.hypot(tree.x - mouseX, tree.y - mouseY);
                if (distance < 20) {
                    overRemovableItem = true;
                    break;
                }
            }
            
            // Check if hovering over a solar panel
            if (!overRemovableItem) {
                for (let solar of solarPanels) {
                    const distance = Math.hypot(solar.x - mouseX, solar.y - mouseY);
                    if (distance < 20) {
                        overRemovableItem = true;
                        break;
                    }
                }
            }
            
            canvas.style.cursor = overRemovableItem ? 'pointer' : 'default';
        });
        
        // Button event listeners
        document.getElementById('treeBtn').addEventListener('click', () => performAction('tree'));
        document.getElementById('cleanupBtn').addEventListener('click', () => performAction('cleanup'));
        document.getElementById('solarBtn').addEventListener('click', () => performAction('solar'));
        document.getElementById('instructionsBtn').addEventListener('click', showInstructions);
        
        document.getElementById('startButton').addEventListener('click', init);
        document.getElementById('nameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') init();
        });
        
        document.getElementById('nameInput').focus();
        
        } // End of setupGame function
    </script>
</body>
</html>
