<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Champions - Multiplayer Climate Action</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            background: #0a0e1a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: white;
        }
        
        #gameCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            pointer-events: none;
        }
        
        #ui > * {
            pointer-events: auto;
        }
        
        #topBar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(180deg, rgba(10,14,26,0.95) 0%, rgba(10,14,26,0) 100%);
        }
        
        #healthContainer {
            flex: 1;
            max-width: 400px;
            text-align: center;
        }
        
        #healthLabel {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #4ade80;
        }
        
        #healthBarOuter {
            width: 100%;
            height: 25px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(74, 222, 128, 0.3);
        }
        
        #healthBarInner {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #4ade80);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        #playerInfo {
            background: rgba(0,0,0,0.6);
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        #playerName {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        #playerStats {
            font-size: 14px;
            opacity: 0.9;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.7);
            padding: 15px 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .action-btn {
            padding: 12px 20px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .action-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
        
        .action-btn.active {
            background: #22c55e;
            border-color: #22c55e;
            color: #0a0e1a;
        }
        
        .btn-icon {
            font-size: 24px;
        }
        
        .btn-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        #leaderboard {
            position: absolute;
            top: 80px;
            right: 20px;
            width: 250px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            max-height: 400px;
            overflow-y: auto;
        }
        
        #leaderboard h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #4ade80;
            text-align: center;
        }
        
        .player-entry {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        .player-entry.you {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
        }
        
        #instructions {
            position: absolute;
            top: 80px;
            left: 20px;
            width: 300px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        #instructions h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #4ade80;
        }
        
        #instructions ul {
            list-style: none;
            padding: 0;
        }
        
        #instructions li {
            padding: 5px 0;
            font-size: 13px;
            opacity: 0.9;
        }
        
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #startScreen h1 {
            font-size: 48px;
            margin-bottom: 20px;
            color: #4ade80;
            text-shadow: 0 0 30px rgba(74, 222, 128, 0.5);
        }
        
        #startScreen p {
            font-size: 18px;
            margin-bottom: 30px;
            opacity: 0.9;
            text-align: center;
            max-width: 600px;
        }
        
        #nameInput {
            padding: 15px 25px;
            font-size: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            margin-bottom: 20px;
            text-align: center;
            width: 300px;
        }
        
        #nameInput::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        #joinBtn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            background: #22c55e;
            border: none;
            border-radius: 10px;
            color: #0a0e1a;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #joinBtn:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }
        
        #status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 18px;
            display: none;
            z-index: 999;
        }
        
        .pollution-alert {
            position: absolute;
            top: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(239, 68, 68, 0.9);
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            animation: slideDown 0.3s ease, fadeOut 2s ease 1s forwards;
            z-index: 100;
        }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -20px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; }
        }
        
        @media (max-width: 768px) {
            #instructions, #leaderboard {
                display: none;
            }
            #controls {
                bottom: 10px;
                padding: 10px;
            }
            .action-btn {
                padding: 10px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui">
        <div id="topBar">
            <div id="playerInfo">
                <div id="playerName">Player</div>
                <div id="playerStats">üå≥ 0 | üßπ 0 | ‚òÄÔ∏è 0 | ‚≠ê 0</div>
            </div>
            
            <div id="healthContainer">
                <div id="healthLabel">üåç GLOBAL ECOSYSTEM HEALTH</div>
                <div id="healthBarOuter">
                    <div id="healthBarInner" style="width: 30%;">30%</div>
                </div>
            </div>
            
            <div style="width: 200px;"></div>
        </div>
        
        <div id="instructions">
            <h3>üìã How to Play</h3>
            <ul>
                <li>üéÆ <strong>WASD/Arrows:</strong> Move</li>
                <li>üå≥ <strong>T or 1:</strong> Plant/Remove Tree</li>
                <li>üßπ <strong>C or 2:</strong> Clean Pollution</li>
                <li>‚òÄÔ∏è <strong>S or 3:</strong> Place/Remove Solar</li>
                <li>üí° <strong>Tip:</strong> Stand on tile to toggle</li>
            </ul>
        </div>
        
        <div id="leaderboard">
            <h3>üèÜ LEADERBOARD</h3>
            <div id="leaderboardList"></div>
        </div>
        
        <div id="controls">
            <button class="action-btn active" id="treeBtn" onclick="setAction('tree')">
                <div class="btn-icon">üå≥</div>
                <div class="btn-label">Tree (T/1)</div>
            </button>
            <button class="action-btn" id="cleanBtn" onclick="setAction('cleanup')">
                <div class="btn-icon">üßπ</div>
                <div class="btn-label">Clean (C/2)</div>
            </button>
            <button class="action-btn" id="solarBtn" onclick="setAction('solar')">
                <div class="btn-icon">‚òÄÔ∏è</div>
                <div class="btn-label">Solar (S/3)</div>
            </button>
        </div>
    </div>
    
    <div id="startScreen">
        <h1>üåç CLIMATE CHAMPIONS üåç</h1>
        <p>Work together with other players around the world to restore Earth's ecosystem! Plant trees, clean pollution, and deploy renewable energy to increase the Global Ecosystem Health to 100%.</p>
        <input type="text" id="nameInput" placeholder="Enter Your Name" maxlength="15">
        <button id="joinBtn">üöÄ JOIN GAME</button>
    </div>
    
    <div id="status"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // Game configuration
        const TILE_SIZE = 40;
        const GRID_WIDTH = 80;
        const GRID_HEIGHT = 60;
        const POLLUTION_SPAWN_INTERVAL = 15000; // Spawn pollution every 15 seconds
        const POLLUTION_SPAWN_AMOUNT = 3; // How many pollution spots to spawn each time
        
        // Canvas setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDnec7-hhj7kcxlS3HOrRGdP3VgOxAeEXY",
            databaseURL: "https://climate-champions-8e318-default-rtdb.firebaseio.com"
        };
        
        let database, gameRef, playerId;
        let isAdmin = false;
        
        // Game state
        let player = { x: 0, y: 0, name: 'Player', trees: 0, cleaned: 0, solar: 0, score: 0 };
        let players = {};
        let pollution = [];
        let trees = [];
        let solarPanels = [];
        let waterTiles = [];
        let currentAction = 'tree';
        let keys = {};
        let camera = { x: 0, y: 0 };
        let globalHealth = 30;
        let pollutionSpawnTimer;
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        gameRef = database.ref('game');
        
        // Generate world
        function generateWorld() {
            waterTiles = [];
            // Create some water patches
            for (let i = 0; i < 8; i++) {
                const cx = Math.random() * GRID_WIDTH;
                const cy = Math.random() * GRID_HEIGHT;
                const radius = 3 + Math.random() * 4;
                
                for (let x = cx - radius; x <= cx + radius; x++) {
                    for (let y = cy - radius; y <= cy + radius; y++) {
                        const dx = x - cx;
                        const dy = y - cy;
                        if (dx*dx + dy*dy <= radius*radius) {
                            const gx = Math.floor(x);
                            const gy = Math.floor(y);
                            if (gx >= 0 && gx < GRID_WIDTH && gy >= 0 && gy < GRID_HEIGHT) {
                                if (!waterTiles.some(w => w.x === gx && w.y === gy)) {
                                    waterTiles.push({x: gx, y: gy});
                                }
                            }
                        }
                    }
                }
            }
        }
        
        function isWater(x, y) {
            return waterTiles.some(w => w.x === x && w.y === y);
        }
        
        // Spawn pollution continuously
        function spawnPollution() {
            if (!isAdmin) return; // Only admin spawns pollution to avoid duplicates
            
            const newPollution = [];
            for (let i = 0; i < POLLUTION_SPAWN_AMOUNT; i++) {
                const x = Math.floor(Math.random() * GRID_WIDTH);
                const y = Math.floor(Math.random() * GRID_HEIGHT);
                
                // Don't spawn on existing pollution, trees, or solar
                const exists = pollution.some(p => p.x === x && p.y === y) ||
                              trees.some(t => t.x === x && t.y === y) ||
                              solarPanels.some(s => s.x === x && s.y === y);
                
                if (!exists) {
                    const pollutionId = Date.now() + '-' + Math.random();
                    newPollution.push({x, y, id: pollutionId});
                }
            }
            
            // Add to Firebase
            if (newPollution.length > 0) {
                newPollution.forEach(p => {
                    gameRef.child('world/pollution/' + p.id).set(p);
                });
                
                // Show alert
                showPollutionAlert(newPollution.length);
            }
        }
        
        function showPollutionAlert(amount) {
            const alert = document.createElement('div');
            alert.className = 'pollution-alert';
            alert.textContent = `‚ö†Ô∏è ${amount} new pollution spot${amount > 1 ? 's' : ''} appeared!`;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }
        
        // Start pollution spawning
        function startPollutionSpawner() {
            if (pollutionSpawnTimer) clearInterval(pollutionSpawnTimer);
            
            // Initial spawn after 10 seconds
            setTimeout(() => {
                spawnPollution();
                // Then spawn regularly
                pollutionSpawnTimer = setInterval(spawnPollution, POLLUTION_SPAWN_INTERVAL);
            }, 10000);
        }
        
        // Join game
        document.getElementById('joinBtn').addEventListener('click', joinGame);
        document.getElementById('nameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinGame();
        });
        
        function joinGame() {
            const name = document.getElementById('nameInput').value.trim() || 'Player';
            player.name = name;
            
            document.getElementById('startScreen').style.display = 'none';
            showStatus('Connecting to server...', 3000);
            
            // Generate player ID
            playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Check if we're the first player (admin)
            gameRef.child('admin').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    // We're the first player - set as admin
                    isAdmin = true;
                    gameRef.child('admin').set(playerId);
                    
                    // Initialize world if needed
                    gameRef.child('world').once('value', (worldSnapshot) => {
                        if (!worldSnapshot.exists()) {
                            initializeWorld();
                        }
                    });
                    
                    // Start pollution spawner
                    startPollutionSpawner();
                }
            });
            
            // Set initial position
            player.x = Math.floor(Math.random() * 30) + 25;
            player.y = Math.floor(Math.random() * 20) + 20;
            
            // Add player to Firebase
            gameRef.child('players/' + playerId).set({
                name: player.name,
                x: player.x,
                y: player.y,
                trees: 0,
                cleaned: 0,
                solar: 0,
                score: 0
            });
            
            // Update player presence
            gameRef.child('players/' + playerId).onDisconnect().remove();
            
            // Listen for changes
            setupListeners();
            
            // Start game loop
            requestAnimationFrame(gameLoop);
            
            // Update UI
            updateUI();
        }
        
        function initializeWorld() {
            // Generate world
            generateWorld();
            
            // Add initial pollution
            const initialPollution = [];
            for (let i = 0; i < 50; i++) {
                const x = Math.floor(Math.random() * GRID_WIDTH);
                const y = Math.floor(Math.random() * GRID_HEIGHT);
                if (!isWater(x, y)) {
                    const pollutionId = Date.now() + '-' + Math.random();
                    initialPollution.push({x, y, id: pollutionId});
                }
            }
            
            // Save to Firebase
            initialPollution.forEach(p => {
                gameRef.child('world/pollution/' + p.id).set(p);
            });
            
            // Save water tiles
            gameRef.child('world/water').set(waterTiles);
            
            // Set initial health
            gameRef.child('health').set(30);
        }
        
        function setupListeners() {
            // Listen for other players
            gameRef.child('players').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                players = {};
                Object.keys(data).forEach(id => {
                    if (id !== playerId) {
                        players[id] = data[id];
                    }
                });
                updateLeaderboard();
            });
            
            // Listen for world state
            gameRef.child('world/pollution').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                pollution = Object.values(data);
                updateHealth();
            });
            
            gameRef.child('world/trees').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                trees = Object.values(data);
                updateHealth();
            });
            
            gameRef.child('world/solar').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                solarPanels = Object.values(data);
                updateHealth();
            });
            
            gameRef.child('world/water').once('value', (snapshot) => {
                waterTiles = snapshot.val() || [];
            });
            
            gameRef.child('health').on('value', (snapshot) => {
                globalHealth = snapshot.val() || 30;
                updateHealthBar();
            });
        }
        
        // Update health calculation
        function updateHealth() {
            const baseHealth = 30;
            const pollutionPenalty = pollution.length * 0.3;
            const treeBonus = trees.length * 0.8;
            const solarBonus = solarPanels.length * 0.5;
            
            let newHealth = baseHealth - pollutionPenalty + treeBonus + solarBonus;
            newHealth = Math.max(0, Math.min(100, newHealth));
            
            if (Math.abs(newHealth - globalHealth) > 0.1) {
                globalHealth = newHealth;
                gameRef.child('health').set(Math.round(newHealth));
            }
        }
        
        function updateHealthBar() {
            const healthBar = document.getElementById('healthBarInner');
            healthBar.style.width = globalHealth + '%';
            healthBar.textContent = Math.round(globalHealth) + '%';
            
            if (globalHealth >= 100) {
                healthBar.style.background = 'linear-gradient(90deg, #fbbf24, #f59e0b)';
                healthBar.textContent = 'üéâ 100% - PLANET SAVED! üéâ';
            }
        }
        
        function updateLeaderboard() {
            const list = document.getElementById('leaderboardList');
            const allPlayers = [
                {id: playerId, ...player},
                ...Object.keys(players).map(id => ({id, ...players[id]}))
            ];
            
            allPlayers.sort((a, b) => b.score - a.score);
            
            list.innerHTML = allPlayers.map((p, i) => `
                <div class="player-entry ${p.id === playerId ? 'you' : ''}">
                    <span>${i + 1}. ${p.name}</span>
                    <span>‚≠ê ${p.score}</span>
                </div>
            `).join('');
        }
        
        // Actions
        function setAction(action) {
            currentAction = action;
            document.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(action === 'tree' ? 'treeBtn' : action === 'cleanup' ? 'cleanBtn' : 'solarBtn').classList.add('active');
        }
        
        function performAction() {
            const px = Math.floor(player.x);
            const py = Math.floor(player.y);
            
            if (currentAction === 'tree') {
                // Check if tree exists here
                const existingTree = trees.find(t => t.x === px && t.y === py);
                if (existingTree) {
                    // Remove tree
                    gameRef.child('world/trees/' + existingTree.id).remove();
                    player.trees = Math.max(0, player.trees - 1);
                    player.score = Math.max(0, player.score - 5);
                    updatePlayerData();
                    showStatus('üå≥ Tree removed', 1000);
                } else if (!isWater(px, py) && !solarPanels.some(s => s.x === px && s.y === py)) {
                    // Plant tree
                    const treeId = Date.now() + '-' + Math.random();
                    gameRef.child('world/trees/' + treeId).set({x: px, y: py, id: treeId});
                    player.trees++;
                    player.score += 5;
                    updatePlayerData();
                    showStatus('üå≥ Tree planted!', 1000);
                }
            } else if (currentAction === 'cleanup') {
                // Clean pollution
                const pollutionHere = pollution.find(p => p.x === px && p.y === py);
                if (pollutionHere) {
                    gameRef.child('world/pollution/' + pollutionHere.id).remove();
                    player.cleaned++;
                    player.score += 10;
                    updatePlayerData();
                    showStatus('üßπ Pollution cleaned!', 1000);
                }
            } else if (currentAction === 'solar') {
                // Check if solar exists here
                const existingSolar = solarPanels.find(s => s.x === px && s.y === py);
                if (existingSolar) {
                    // Remove solar
                    gameRef.child('world/solar/' + existingSolar.id).remove();
                    player.solar = Math.max(0, player.solar - 1);
                    player.score = Math.max(0, player.score - 3);
                    updatePlayerData();
                    showStatus('‚òÄÔ∏è Solar removed', 1000);
                } else if (!isWater(px, py) && !trees.some(t => t.x === px && t.y === py)) {
                    // Place solar
                    const solarId = Date.now() + '-' + Math.random();
                    gameRef.child('world/solar/' + solarId).set({x: px, y: py, id: solarId});
                    player.solar++;
                    player.score += 3;
                    updatePlayerData();
                    showStatus('‚òÄÔ∏è Solar deployed!', 1000);
                }
            }
        }
        
        function updatePlayerData() {
            gameRef.child('players/' + playerId).update({
                x: player.x,
                y: player.y,
                trees: player.trees,
                cleaned: player.cleaned,
                solar: player.solar,
                score: player.score
            });
            updateUI();
        }
        
        function updateUI() {
            document.getElementById('playerName').textContent = player.name;
            document.getElementById('playerStats').textContent = 
                `üå≥ ${player.trees} | üßπ ${player.cleaned} | ‚òÄÔ∏è ${player.solar} | ‚≠ê ${player.score}`;
        }
        
        function showStatus(message, duration = 2000) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
            setTimeout(() => status.style.display = 'none', duration);
        }
        
        // Input handling
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            
            if (e.key === '1' || e.key.toLowerCase() === 't') {
                setAction('tree');
                performAction();
            } else if (e.key === '2' || e.key.toLowerCase() === 'c') {
                setAction('cleanup');
                performAction();
            } else if (e.key === '3' || e.key.toLowerCase() === 's') {
                setAction('solar');
                performAction();
            } else if (e.key === ' ') {
                e.preventDefault();
                performAction();
            }
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });
        
        // Game loop
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        function update() {
            const speed = 0.15;
            
            if (keys['w'] || keys['W'] || keys['ArrowUp']) player.y -= speed;
            if (keys['s'] || keys['S'] || keys['ArrowDown']) player.y += speed;
            if (keys['a'] || keys['A'] || keys['ArrowLeft']) player.x -= speed;
            if (keys['d'] || keys['D'] || keys['ArrowRight']) player.x += speed;
            
            player.x = Math.max(0, Math.min(GRID_WIDTH - 1, player.x));
            player.y = Math.max(0, Math.min(GRID_HEIGHT - 1, player.y));
            
            // Update camera
            camera.x = player.x * TILE_SIZE - canvas.width / 2;
            camera.y = player.y * TILE_SIZE - canvas.height / 2;
            
            // Update player position in Firebase (throttled)
            if (Math.random() < 0.1) {
                gameRef.child('players/' + playerId + '/x').set(player.x);
                gameRef.child('players/' + playerId + '/y').set(player.y);
            }
        }
        
        function draw() {
            ctx.fillStyle = '#2d5016';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            for (let x = 0; x < GRID_WIDTH; x++) {
                for (let y = 0; y < GRID_HEIGHT; y++) {
                    const sx = x * TILE_SIZE - camera.x;
                    const sy = y * TILE_SIZE - camera.y;
                    
                    if (sx < -TILE_SIZE || sx > canvas.width || sy < -TILE_SIZE || sy > canvas.height) continue;
                    
                    // Draw tile
                    if (isWater(x, y)) {
                        ctx.fillStyle = '#1e40af';
                    } else {
                        ctx.fillStyle = (x + y) % 2 === 0 ? '#3d6b1f' : '#2d5016';
                    }
                    ctx.fillRect(sx, sy, TILE_SIZE, TILE_SIZE);
                }
            }
            
            // Draw pollution
            pollution.forEach(p => {
                const sx = p.x * TILE_SIZE - camera.x;
                const sy = p.y * TILE_SIZE - camera.y;
                ctx.fillStyle = '#7f1d1d';
                ctx.fillRect(sx, sy, TILE_SIZE, TILE_SIZE);
                ctx.fillStyle = '#991b1b';
                ctx.fillRect(sx + 5, sy + 5, TILE_SIZE - 10, TILE_SIZE - 10);
            });
            
            // Draw trees
            trees.forEach(t => {
                const sx = t.x * TILE_SIZE - camera.x;
                const sy = t.y * TILE_SIZE - camera.y;
                ctx.fillStyle = '#15803d';
                ctx.beginPath();
                ctx.arc(sx + TILE_SIZE/2, sy + TILE_SIZE/2, TILE_SIZE * 0.4, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Draw solar panels
            solarPanels.forEach(s => {
                const sx = s.x * TILE_SIZE - camera.x;
                const sy = s.y * TILE_SIZE - camera.y;
                ctx.fillStyle = '#1e40af';
                ctx.fillRect(sx + 5, sy + 5, TILE_SIZE - 10, TILE_SIZE - 10);
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.strokeRect(sx + 5, sy + 5, TILE_SIZE - 10, TILE_SIZE - 10);
            });
            
            // Draw players
            Object.values(players).forEach(p => {
                const sx = p.x * TILE_SIZE - camera.x;
                const sy = p.y * TILE_SIZE - camera.y;
                ctx.fillStyle = '#fbbf24';
                ctx.beginPath();
                ctx.arc(sx + TILE_SIZE/2, sy + TILE_SIZE/2, TILE_SIZE * 0.3, 0, Math.PI * 2);
                ctx.fill();
                
                // Name
                ctx.fillStyle = 'white';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(p.name, sx + TILE_SIZE/2, sy - 5);
            });
            
            // Draw current player
            const sx = player.x * TILE_SIZE - camera.x;
            const sy = player.y * TILE_SIZE - camera.y;
            ctx.fillStyle = '#22c55e';
            ctx.beginPath();
            ctx.arc(sx + TILE_SIZE/2, sy + TILE_SIZE/2, TILE_SIZE * 0.3, 0, Math.PI * 2);
            ctx.fill();
            
            // Player name
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(player.name, sx + TILE_SIZE/2, sy - 5);
            
            // Current tile highlight
            const px = Math.floor(player.x);
            const py = Math.floor(player.y);
            const hx = px * TILE_SIZE - camera.x;
            const hy = py * TILE_SIZE - camera.y;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 3;
            ctx.strokeRect(hx, hy, TILE_SIZE, TILE_SIZE);
        }
        
        // Focus name input
        document.getElementById('nameInput').focus();
    </script>
</body>
</html>
